/**
 * Chat RAO - Asner
 */
function array_flip(e){var t,n={};for(t in e)e.hasOwnProperty(t)&&(n[e[t]]=t);return n}function Interval(e,t){var n=!1;this.start=function(){this.isRunning()||(n=setInterval(e,t))},this.stop=function(){clearInterval(n),n=!1},this.isRunning=function(){return n!==!1}}function cancelEvent(e){e.preventDefault(),e.stopPropagation()}function getRank(e){return $.grep($config.rangos,function(t){return t.id==e})[0]}function chatboxResponsive(){$(".chatbox").height($(window).height()-2*$("#messageBox").height()-50),$("#sideUsers").height($(window).height()-2*$("#messageBox").height()-10)}function getMessageUsers(){$.getJSON($baseUrl+"/private/messages",function(e){if(e.length){$("#contactList").html("");var t=null;$.each(e,function(e,n){$userID===n.id?t={id:n.to_id,user:n.to_user,image:$baseUrl+"/avatar/s/"+n.to_image,chatColor:n.to_color,chatText:n.to_text,message:"Tu: "+n.message,send_date:n.send_date,time:moment.unix(n.send_date).fromNow(),seen:1}:(t=n,t.time=moment.unix(n.send_date).fromNow(),t.image=$baseUrl+"/avatar/s/"+n.image),$("#contactList").append($mainContactTemplate(t))})}})}function getUserMessages(e){$userID!=currentLocation&&(swal({title:"Cargando mensajes...",text:"Espere un momento mientras se cargan los mensajes...",imageUrl:$baseUrl+"/assets/img/loading_spin.gif",showConfirmButton:!1}),$.getJSON($baseUrl+"/private/messages/user/"+e,function(t){return t.length?($chatbox.html(""),$.each(t.reverse(),function(e,t){t.originalTime=t.send_date,t.time=moment.unix(t.send_date).fromNow(),t.image=$baseUrl+"/avatar/s/"+t.image,handleMessage(t)}),chatBottom(),$("#user-"+e+" a").removeClass("notseen"),void swal.close()):($chatbox.html("¡Se el primero en enviarle un mensaje!"),void swal.close())}))}function getCache(){$.getJSON("cache/client.json?time"+(new Date).getTime(),function(e){$config.rangos=[],$config.smilies=e.smilies,$config.autocomplete[0]=[],$.each(e.ranks,function(e,t){$config.autocomplete[0].push(t.name),$config.rangos.push({id:t.id,name:t.name,permission:JSON.parse(t.chatPermissions)})}),$.each($config.smilies,function(e,t){$config.autocomplete[0].push(":"+t.code+":")}),$config.ready||(socket.emit("ready",{ready:!0}),$config.ready=!0)})}function linkifyChat(e){var t=/(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,n=/\b(https?:\/\/\S+\.(?:png|jpe?g|gif)\S*)\b/,a=/\b(https?:\/\/\S+\.(?:mp3|ogg)\S*)\b/,o=/\b(https?:\/\/\S+\.(?:mp4|webm|ogv)\S*)\b/;return e.replace(t,function(e){return n.test(e)?'<a href="'+e+'" target="_blank"><span class="smilie"><img src="'+e+'"/></span></a>':a.test(e)?'<audio controls><source src="'+e+'">Tu navegador no soporta la etiqueta "Audio"</audio>':o.test(e)?'<video class="srcVideo" src="'+e+'" preload controls></video>':'<a href="'+e+'" target="_blank">'+e+"</a>"})}function smilies(e){var t=0;return $.each($config.smilies,function(n,a){var o=a,s=new RegExp(":"+o.code+":","g");return!(t>3)&&void(e=e.replace(s,function(e){if(t++,t>3)return a.code;var n=o.url;return o.local&&(n=$baseUrl+"/smilies/"+o.url),'<span class="smilie"><img src="'+n+'" title="'+o.code+'"/></span>'}))}),e}function chatBottom(){$chatbox.scrollTop($chatbox[0].scrollHeight+480)}function handleMessage(e){if($config.ready){var t=getRank(e.rank);e.id!==$userID?($("#user-"+e.id+" .timeAgo").text(" "+moment.unix(e.originalTime).fromNow()),$("#user-"+e.id+" .timeAgo").data("time",e.originalTime),$("#user-"+e.id+" p").html(e.message)):($("#user-"+currentLocation+" .timeAgo").text(" "+moment.unix(e.originalTime).fromNow()),$("#user-"+currentLocation+" .timeAgo").data("time",e.originalTime),$("#user-"+currentLocation+" p").html("Tu: "+e.message)),e.message=linkifyChat(e.message,t.permission),e.message=smilies(e.message),e.user!=$config.lastUser?($config.lastUser=e.user,e.rank=t.name,$chatbox.append($messageTemplate(e))):($(".contenido").last().find(".timeAgo").text(" "+moment.unix(e.originalTime).fromNow()),$(".contenido").last().append($messageChildTemplate(e))),$chat.focus||($chat.counter++,$chat.interval instanceof Interval||($chat.interval=new Interval(function(){$("title").text($("title").text()===$chat.title?"Nuevo mensaje ("+$chat.counter+")":$chat.title)},2e3)),$chat.interval.isRunning()||$chat.interval.start()),$chatbox.scrollTop()+$(document).height()>=$chatbox[0].scrollHeight-480&&chatBottom()}}var $userTemplate=Handlebars.compile($("#userTemplate").html()),$user=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:$baseUrl+"/perfil/search/%QUERY"}});$user.initialize(),$("#inputUser").typeahead({minLength:3},{display:"user",limit:10,source:$user.ttAdapter(),templates:{empty:['<div class="empty-message">',"No se encontró a ningún usuario con este nombre.","</div>"].join("\n"),suggestion:$userTemplate}}),Handlebars.registerHelper("unescape",function(e){return new Handlebars.SafeString(e)});var $config={ready:!1,user:null,lastUser:null,smilies:null,rangos:null,autocomplete:[]},$chat={last:(new Date).getTime(),title:document.title,focus:!0,counter:0,interval:null,seed:Math.floor(Math.random()*-9)+20},socket=io.connect("/privado"),$mainContactTemplate=Handlebars.compile($("#mainContactTemplate").html()),$messageTemplate=Handlebars.compile($("#messageTemplate").html()),$messageChildTemplate=Handlebars.compile($("#messageChildTemplate").html()),$chatbox=$(".chatbox"),sendReady=!0,currentLocation=location.hash.slice(1);socket.on("message",function(e){currentLocation==e.id||e.id===$userID?(e.originalTime=moment().unix(),e.time=moment().fromNow(),handleMessage(e)):($("#user-"+e.id).insertBefore($(".sidemenu .left").first()),e.send_date=moment().unix(),e.time=moment().fromNow(),e.seen=0,$("#user-"+e.id).remove(),$("#contactList").prepend($mainContactTemplate(e))),$chat.focus||($chat.counter++,$chat.interval instanceof Interval||($chat.interval=new Interval(function(){$("title").text($("title").text()===$chat.title?"Nuevo mensaje ("+$chat.counter+")":$chat.title)},2e3)),$chat.interval.isRunning()||$chat.interval.start())}),socket.on("restart",function(){console.log("Go restart"),setTimeout(function(){window.location.reload()},1e3)}),socket.on("client-update",function(e){getCache()}),socket.on("global",function(e){$("#globalUser").text("¡"+e.user+" ha enviado un mensaje global!"),$("#globalMessage").html(linkifyGlobal(e.message)),$("#modalGlobal").modal("show")}),$("#messageBox").submit(function(e){cancelEvent(e);var t=$("#messageBox input");return!(!t.val()||!sendReady)&&(""!==currentLocation&&(socket.emit("message",{to:parseInt(currentLocation),message:t.val()}),sendReady=!1,setTimeout(function(){sendReady=!0},1e3),void t.val("")))}),$(window).focus(function(){$chat.interval instanceof Interval&&$chat.interval.stop(),$chat.focus=!0,$chat.counter=0,$("title").text($chat.title)}),$(window).blur(function(){$chat.focus=!1}),$(window).on("hashchange",function(){$("#user-"+currentLocation+" a").removeClass("cursor"),currentLocation=location.hash.slice(1),getUserMessages(currentLocation),$("#user-"+currentLocation+" a").addClass("cursor")}),$(window).on("resize",function(){chatboxResponsive(),chatBottom()}),$(document).ready(function(){""!==currentLocation&&getUserMessages(currentLocation),$("#messageBox input").tabComplete($config.autocomplete)}),setInterval(function(){$(".timeAgo").each(function(e,t){var n=$(t).data("time");$(t).text(" "+moment.unix(n).fromNow())})},6e4),getCache(),getMessageUsers(),chatboxResponsive();