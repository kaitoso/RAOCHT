/**
 * Chat RAO - Asner
 */
function array_flip(e){var t,n={};for(t in e)e.hasOwnProperty(t)&&(n[e[t]]=t);return n}function Interval(e,t){var n=!1;this.start=function(){this.isRunning()||(n=setInterval(e,t))},this.stop=function(){clearInterval(n),n=!1},this.isRunning=function(){return n!==!1}}function cancelEvent(e){e.preventDefault(),e.stopPropagation()}function getRank(e){return $.grep($config.rangos,function(t){return t.id==e})[0]}function smilies(e){var t=0;return $.each($config.smilies,function(n,o){var a=o,i=new RegExp(":"+a.code+":","g");return!(t>3)&&void(e=e.replace(i,function(e){if(t++,t>3)return o.code;var n=a.url;return a.local&&(n=$baseUrl+"/smilies/"+a.url),'<span class="smilie"><img src="'+n+'" title=":'+a.code+':"/></span>'}))}),e}function linkifyChat(e,t){var n=/(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,o=/\b(https?:\/\/\S+(?:png|jpe?g|gif)\S*)\b/,a=/\b(https?:\/\/\S+(?:mp3|ogg)\S*)\b/,i=/\b(https?:\/\/\S+(?:mp4|webm|ogv)\S*)\b/,s=array_flip(t);return e.replace(n,function(e){return o.test(e)&&null!=s.images?'<a href="'+e+'" target="_blank"><span class="smilie"><img src="'+e+'"/></span></a>':a.test(e)&&null!=s.audio?'<audio controls><source src="'+e+'">Tu navegador no soporta la etiqueta "Audio"</audio>':i.test(e)&&null!=s.videos?'<a data-toggle="modal" href="#modalvideo" class="openVideo" data-video="'+e+'">'+e+"</a>":'<a href="'+e+'" target="_blank">'+e+"</a>"})}function linkifyGlobal(e){var t=/(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,n=/\b(https?:\/\/\S+(?:png|jpe?g|gif)\S*)\b/,o=/\b(https?:\/\/\S+(?:mp3|ogg)\S*)\b/,a=/\b(https?:\/\/\S+(?:mp4|webm|ogv)\S*)\b/;return e.replace(t,function(e){return n.test(e)?'<a href="'+e+'" target="_blank"><img src="'+e+'" title="'+e+'" class="img-responsive img-center"></a>':o.test(e)?'<audio autoplay controls><source src="'+e+'">Tu navegador no soporta la etiqueta "Audio"</audio>':a.test(e)?$videoTemplate({video:e}):'<a href="'+e+'" target="_blank">'+e+"</a>"})}function chatBottom(){$chatbox.scrollTop($chatbox[0].scrollHeight+480)}function handleMessage(e){if($config.ready){var t=getRank(e.rank);e.message=linkifyChat(e.message,t.permission),e.message=smilies(e.message),e.user!=$config.lastUser?($config.lastUser=e.user,e.rank=t.name,$chatbox.append($messageTemplate(e)),$utils.messages++):$(".contenido").last().append($messageChildTemplate(e)),$chat.focus||($chat.counter++,$chat.interval instanceof Interval||($chat.interval=new Interval(function(){$("title").text($("title").text()===$chat.title?"Nuevo mensaje ("+$chat.counter+")":$chat.title)},2e3)),$chat.interval.isRunning()||$chat.interval.start()),$chatbox.scrollTop()+$(document).height()>=$chatbox[0].scrollHeight-480&&chatBottom()}}function getCurrentDate(){return(new Date).toLocaleDateString("es-419",{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"})}function getCache(){$.getJSON("cache/client.json?time"+(new Date).getTime(),function(e){$config.rangos=[],$config.smilies=e.smilies,$config.autocomplete[0]=[],$config.autocomplete[2]=["/kick","/reiniciar","/global","/clean","/stat"],$.each(e.ranks,function(e,t){$config.autocomplete[0].push(t.name),$config.rangos.push({id:t.id,name:t.name,permission:JSON.parse(t.chatPermissions)})}),$.each($config.smilies,function(e,t){$config.autocomplete[0].push(":"+t.code+":")}),$config.ready||(socket.emit("ready",{ready:!0}),$config.ready=!0,$chat.check=new Interval(function(){var e=$("#controlRank").data("rank"),t=array_flip(getRank(e).permission);if(null!=t.nokick)return void $chat.check.stop();var n=(new Date).getTime();n>$chat.last+1e3*$chat.seed*60&&($chat.check.stop(),socket.disconnect(),$.getJSON($baseUrl+"/logout",function(e){console.log(e)}),swal({title:"¡Te han pateado!",text:"Por la razón de: estuviste más de "+$chat.seed+" minutos sin enviar ningún mensaje",type:"warning",showCancelButton:!1,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"¡Ya que!"}).then(function(){window.location.href=$baseUrl+"/login"}))},3e4),$chat.check.start())})}function getLogros(e){var t=[],n=$baseUrl+"/cuenta/logros.json";e>0&&(n+="/"+e),$.getJSON(n,function(e){$.each(e,function(e,n){t.push({title:"¡Nuevo logro desbloqueado!",html:$logroTemplate(n),showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"¡Genial!"})}),swal.queue(t)})}function chatboxResponsive(){$(".chatbox").height($(window).height()-2*$("#messageBox").height()+1)}Handlebars.registerHelper("unescape",function(e){return new Handlebars.SafeString(e)});var socket=io.connect("/chat"),$messageTemplate=Handlebars.compile($("#messageTemplate").html()),$messageChildTemplate=Handlebars.compile($("#messageChildTemplate").html()),$usersTemplate=Handlebars.compile($("#usersTemplate").html()),$chatbox=$(".chatbox"),$videoTemplate=Handlebars.compile($("#videoTemplate").html()),$logroTemplate=Handlebars.compile($("#logroTemplate").html()),$smiliesTemplate=Handlebars.compile($("#smiliesTemplate").html()),sendReady=!0,$config={ready:!1,user:null,lastUser:null,smilies:null,rangos:null,autocomplete:[]},$utils={messages:0,saveConfig:!0,smiliesShown:0,smiliesLock:!1},$system={user:"Sistema",chatName:"Sistema",chatText:"f50c0c",chatColor:"f50c0c",image:$baseUrl+"/avatar/sys.png",rank:1},$chat={last:(new Date).getTime(),title:document.title,focus:!0,counter:0,interval:null,privates:0,seed:Math.floor(6*Math.random()+20),check:null};socket.on("message",function(e){e.time=getCurrentDate(),handleMessage(e)}),socket.on("privado",function(e){alertify.log("<strong>"+e.user+"</strong> te ha envíado un mensaje!<br> "+e.message,"",0),$chat.privates++,$("#pvNumber").text($chat.privates)}),socket.on("system",function(e){$system.time=getCurrentDate(),$system.message=e.message,$system.rank=1,handleMessage($system)}),socket.on("update",function(e){var t=getRank(e.rank),n=array_flip(t.permission);$("#controlUser").text(e.user),$("#controlRank").text(t.name),$("#controlRank").data("rank",e.rank),$("#controlImage").attr("src",e.image),t.permission.length>0?$("#adminView").show():$("#adminView").hide(),void 0===n.nokick&&$chat.check.start()}),socket.on("global",function(e){$("#globalUser").text("¡"+e.user+" ha enviado un mensaje global!"),$("#globalMessage").html(linkifyGlobal(e.message)),$("#modalGlobal").modal("show")}),socket.on("background",function(e){console.log(e),null!=e.background?$("#mainContainer").css("background","url('"+e.background+"') no-repeat scroll left center / cover"):$("#mainContainer").css("background","none"),null!=e.side?$("#myNavmenu").css("background","rgba(0, 0, 0, 0) url('"+e.side+"') no-repeat scroll left center / cover"):$("#myNavmenu").css("background","rgba(0, 0, 0, 0.87)")}),socket.on("achievement",function(e){getLogros(e.id)}),socket.on("client-update",function(e){getCache()}),socket.on("online",function(e){$("#chatUsuarios").html(""),$config.autocomplete[1]=[],$.each(e,function(e,t){$config.autocomplete[1].push(t.user),$("#chatUsuarios").append($usersTemplate(t))}),$("#onlineCount").text(e.length)}),socket.on("restart",function(){console.log("Go restart"),setTimeout(function(){window.location.reload()},1e3)}),socket.on("offline",function(){$chat.check instanceof Interval&&$chat.check.stop(),socket.disconnect(),$.getJSON($baseUrl+"/logout",function(e){window.location.href=$baseUrl+"/login"})}),socket.on("kick",function(e){$chat.check instanceof Interval&&$chat.check.stop(),socket.disconnect(),$.getJSON($baseUrl+"/logout",function(e){console.log(e)}),swal({title:"¡Te han pateado!",text:"Por la razón de: "+e.reason,type:"warning",showCancelButton:!1,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"¡Ya que!"}).then(function(){window.location.href=$baseUrl+"/login"})}),socket.on("activity",function(){$chat.last=(new Date).getTime()}),socket.on("disconnect",function(){console.log("Desconectado")}),$("#messageBox").submit(function(e){cancelEvent(e);var t=$("#messageBox input");return!(!t.val()||!sendReady)&&(socket.emit("message",{message:t.val()}),sendReady=!1,setTimeout(function(){sendReady=!0},1e3),$chat.last=(new Date).getTime(),void t.val(""))}),$(".chatbox").on("click",".openVideo",function(e){e.preventDefault();var t=$(this).data("video"),n=$("#videoModal");n.attr("src",t),n[0].play()}),$("#modalGlobal").on("hidden.bs.modal",function(){$("#globalMessage").html("")}),$("#openSmilies").on("click",function(e){e.preventDefault(),$("#modalSmilies").modal("show")}),$("#modalSmilies").on("show.bs.modal",function(e){$("#bodySmilies").empty(),$utils.smiliesShown=30;var t=$config.smilies.length;t/30<1?$utils.smiliesLock=!0:t=30;for(var n=0;n<t;n++)$("#bodySmilies").append($smiliesTemplate($config.smilies[n]))}),$("#modalSmilies").on("hidden.bs.modal",function(e){$utils.smiliesLock=!1,$utils.smiliesShown=0}),$("#modalSmilies").scroll(function(e){if(!($("#modalSmilies .modal-dialog").height()>=$("#modalSmilies").scrollTop()+$(document).height()||$utils.smiliesLock)){var t=$config.smilies.length;if($utils.smiliesShown==t)return void($utils.smiliesLock=!0);for(var n=t-$utils.smiliesShown,o=n>=20?20:n,a=$utils.smiliesShown,i=o;i>0;a++,i--)$("#bodySmilies").append($smiliesTemplate($config.smilies[a]));$utils.smiliesShown+=o}}),$("#btnPrivate").on("click",function(){$chat.privates=0,$("#pvNumber").text($chat.privates)}),$("#bodySmilies").on("click",".smilieTemplate",function(e){cancelEvent(e),$("#messageBox input").val($("#messageBox input").val()+$(this).data("code"));var t=$("#messageBox input");setImmediate(function(){t.selectionStart=t.selectionEnd=256}),$("#modalSmilies").modal("hide"),$("#messageBox input").focus()}),$(window).on("resize",function(){chatboxResponsive(),chatBottom()}),$(window).focus(function(){$chat.interval instanceof Interval&&$chat.interval.stop(),$chat.focus=!0,$chat.counter=0,$("title").text($chat.title)}),$(window).blur(function(){$chat.focus=!1}),$(document).ready(function(){chatboxResponsive(),getCache(),getLogros(0),$("#messageBox input").tabComplete($config.autocomplete)}),$("body").on("swipe",function(){$(document).width()<958&&$(".navmenu").offcanvas("toggle")});
